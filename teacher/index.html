<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Giáo viên điều khiển</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    /* Đặt style giống như bạn đã viết */
  </style>
</head>
<body>

<!-- Các phần tử trong giao diện HTML của bạn -->
<div id="questionList">
  <h3>Câu hỏi</h3>
</div>

<div id="mainArea">
   <img src="images/banner.png" style="width: 90%; height: auto;">

  <div id="controlPanel">
    <button onclick="openExplain(1)">📖 Giải thích 1</button>
    <button onclick="openExplain(2)">📖 Giải thích 2</button>
    <button onclick="openExplain(3)">📖 Giải thích 3</button>
    <button onclick="openExplain(4)">📖 Giải thích 4</button>
  </div>

  <div id="currentQuestionInfo">
    <div id="countdown">⏱️ Còn lại: —</div>
    <img id="questionImage" src="" alt="Hình câu hỏi">
  </div>

  <div id="resultArea">
    <h3>📋 Kết quả trả lời:</h3>
    <table>
      <thead>
        <tr>
          <th>👤 Nhóm</th>
          <th>🅰️ Phương án</th>
          <th>🏆 Điểm</th>
        </tr>
      </thead>
      <tbody id="answerList"></tbody>
    </table>
  </div>

  <div id="resetButtonContainer">
    <button onclick="resetSystem()">🔄 Reset</button>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB-ST5U4VSxraEGKl3INjGKKdl9Dik5bg0",
  authDomain: "giaiphong2025-697c5.firebaseapp.com",
  databaseURL: "https://giaiphong2025-697c5-default-rtdb.firebaseio.com",
  projectId: "giaiphong2025-697c5",
  storageBucket: "giaiphong2025-697c5.appspot.com",
  messagingSenderId: "205746810625",
  appId: "1:205746810625:web:ec05b354a6221f7b3af500"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const questionListEl = document.getElementById("questionList");
const questionImage = document.getElementById("questionImage");
const countdownEl = document.getElementById("countdown");
const answerListEl = document.getElementById("answerList");

let countdownInt = null;
let currentQuestion = null;

const correctAnswers = {
  cau1: "B", cau2: "C", cau3: "C", cau4: "D", cau5: "B",
  cau6: "D", cau7: "A", cau8: "D", cau9: "A", cau10: "D"
};

let teamScores = { team1: 0, team2: 0 };

for (let i = 1; i <= 10; i++) {
  const btn = document.createElement("button");
  btn.textContent = "Câu " + i;
  btn.onclick = () => startQuestion(i, btn);
  questionListEl.appendChild(btn);
}

function startQuestion(qn, btn) {
  clearInterval(countdownInt);
  currentQuestion = qn;

  const padded = String(qn).padStart(2, '0');
  const imgPath = `./images/C${padded}.png`;

  db.ref("currentQuestion").set({ number: qn });
  answerListEl.innerHTML = "";

  document.querySelectorAll("#questionList button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");

  questionImage.style.display = "block";
  questionImage.src = imgPath;
  startCountdown(qn === 1 ? 90 : 30);
}

function startCountdown(sec) {
  let t = sec;
  countdownEl.innerText = `⏱️ ${t}s`;
  countdownInt = setInterval(() => {
    t--;
    countdownEl.innerText = `⏱️ ${t}s`;
    if (t <= 0) {
      clearInterval(countdownInt);
      countdownEl.innerText = "⏱️ 0s";
      loadAnswers();
    }
  }, 1000);
}

function loadAnswers() {
  if (!currentQuestion) return;

  db.ref("answers").once("value", snap => {
    const data = snap.val();
    answerListEl.innerHTML = "";

    if (data) {
      const studentScores = {};

      for (const name in data) {
        const answers = data[name];
        const ansKey = "cau" + currentQuestion;

        let studentAnswer = answers[ansKey] || "Không chọn";
        studentAnswer = studentAnswer.toString().trim().toUpperCase();

        // Kiểm tra nếu không phải A/B/C/D thì đánh dấu là "Không chọn"
        if (!["A", "B", "C", "D"].includes(studentAnswer)) {
          studentAnswer = "Không chọn";
        }

        const correctAnswer = correctAnswers[ansKey];
        const score = (studentAnswer === correctAnswer) ? 3 : 0;

        // Cộng điểm cho nhóm
        if (name.startsWith("Team1")) {
          teamScores.team1 += score;
        } else if (name.startsWith("Team2")) {
          teamScores.team2 += score;
        }

        // Tạo bảng kết quả
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${name}</td><td>${studentAnswer}</td><td>${score}</td>`;
        answerListEl.appendChild(tr);
      }

      const total = teamScores.team1 + teamScores.team2;
      document.getElementById("totalScore").innerText = `🎯 Tổng điểm: ${total}`;
    }
  });
}

function resetSystem() {
  clearInterval(countdownInt);
  db.ref("currentQuestion").remove();
  db.ref("answers").remove();
  db.ref("resetSignal").set(Date.now());
  questionImage.src = "";
  countdownEl.innerText = "⏱️ Còn lại: —";
  answerListEl.innerHTML = "";
  teamScores = { team1: 0, team2: 0 };
  alert("Đã reset toàn bộ hệ thống!");
}

function openExplain(number) {
  const links = {
    1: 'https://example.com/giai-thich-1',
    2: 'https://example.com/giai-thich-2',
    3: 'https://example.com/giai-thich-3',
    4: 'https://example.com/giai-thich-4'
  };
  window.open(links[number], '_blank');
}
</script>

</body>
</html>
